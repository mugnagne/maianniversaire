<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brest Pocket Guide</title>

  <!-- Favicon citrouille -->
  <link rel="icon" href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect width="64" height="64" rx="12" ry="12" fill="%230B0B0F"/>
      <g transform="translate(0,2)">
        <ellipse cx="32" cy="36" rx="20" ry="18" fill="%23FF7A00"/>
        <ellipse cx="22" cy="36" rx="12" ry="16" fill="%23FF6A00"/>
        <ellipse cx="42" cy="36" rx="12" ry="16" fill="%23FF6A00"/>
        <rect x="30" y="9" width="6" height="10" rx="2" fill="%233A8F2E"/>
        <path d="M29,12 C26,8 22,8 20,10" stroke="%233A8F2E" stroke-width="2" fill="none"/>
        <circle cx="26" cy="32" r="3" fill="%230B0B0F"/>
        <circle cx="38" cy="32" r="3" fill="%230B0B0F"/>
        <path d="M24,40 C28,43 36,43 40,40" stroke="%230B0B0F" stroke-width="3" fill="none" stroke-linecap="round"/>
      </g>
    </svg>' />

  <!-- Google Fonts: Amarante -->
  <link href="https://fonts.googleapis.com/css2?family=Amarante&display=swap" rel="stylesheet">

  <!-- MapLibre GL -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    :root {
      --pink:#FF3366; --orange:#FF5733;
      --bg: rgba(255,255,255,0.06);
      --bg-strong: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.16);
      --shadow: 0 8px 28px rgba(0,0,0,.45);
      --text: #FFFFFF; --muted:#A7A7A7;
      --accent:#7CB8FF;
    }
    *{ box-sizing: border-box }
    html,body{ height:100%; margin:0; background:#0B0B0F; color:var(--text); font-family:"Amarante", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial }
    #map{ position:fixed; inset:0 }

    /* Forcer Amarante sur toute l’UI MapLibre incluse */
    html, body, #map,
    button, input, select, textarea,
    .card, .fab, .drawer, .list-item, .lbl,
    .maplibregl-ctrl, .maplibregl-ctrl button, .maplibregl-ctrl-group button,
    .maplibregl-popup, .maplibregl-popup-content, .maplibregl-popup * {
      font-family: "Amarante", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial !important;
      font-weight: 400;
    }

    .topbar{ position:fixed; top:10px; left:12px; right:12px; display:flex; gap:8px; justify-content:space-between; z-index:5 }
    .card{ background:var(--bg); backdrop-filter: blur(8px); padding:8px 12px; border-radius:16px; box-shadow:var(--shadow); border:1px solid var(--border); font-weight:600; color:var(--text) }
    .fabs{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; display:flex; gap:8px; z-index:5; flex-wrap:wrap; justify-content:center }
    .fab{ background:var(--bg); border:1px solid var(--border); padding:10px 14px; border-radius:16px; box-shadow:var(--shadow); font-weight:600; color:var(--text) }

    .drawer{ position:fixed; left:0; right:0; bottom:0; background:#111218; border-radius:24px 24px 0 0; box-shadow:0 -16px 36px rgba(0,0,0,.6); max-height:60vh; overflow:auto; padding:16px; z-index:6; border-top:1px solid var(--border) }
    .list-item{ border:1px solid var(--border); border-radius:16px; padding:12px; display:grid; gap:6px; background:var(--bg-strong) }
    .muted{ color:var(--muted) }

    /* MARKERS EMOJI */
    .mk { width:26px; height:26px; border-radius:999px; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.45); cursor:pointer; display:flex; align-items:center; justify-content:center; background:#1e1f26 }
    .mk-emoji { font-size:18px; line-height:1 }

    .lbl{ white-space:nowrap; font-size:12px; padding:2px 6px; border-radius:10px; background:var(--bg-strong); border:1px solid var(--border); box-shadow:var(--shadow); transform:translateY(-6px); color:var(--text) }

    .route-badge{ position:fixed; left:50%; transform:translateX(-50%); bottom:78px; z-index:5 }
    button{ color:var(--text) }
    input, textarea, select{ background:#0F1016; color:var(--text); border:1px solid var(--border); border-radius:10px; }
    input[type="color"]{ background:transparent; border:none; }
    a{ color:var(--accent) }

    /* POPUPS LISIBLES : fond blanc -> texte noir */
    .maplibregl-popup-content{ background:#fff; color:#111; }
    .maplibregl-popup-tip{ border-top-color:#fff !important; }
    .maplibregl-popup-content button{ color:#111; background:#f3f4f6; border:1px solid #d9dbe1; border-radius:10px; padding:6px 10px; }
    .maplibregl-popup-content strong{ color:#111 }
    .maplibregl-popup-content .muted{ color:#333 }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="card">🎃 Brest Pocket Guide</div>
    <div style="display:flex; gap:8px">
      <button id="btn-list" class="card" aria-label="Ouvrir la liste">Lieux (0)</button>
      <button id="btn-labels" class="card" aria-label="Afficher/masquer les noms">Noms</button>
      <button id="btn-style" class="card" aria-label="Changer de style">Style</button>
      <button id="btn-add" class="card" aria-label="Mode ajout">Ajout</button>
    </div>
  </div>

  <div class="route-badge" id="route-badge" style="display:none">
    <div class="card" style="display:flex; gap:8px; align-items:center">
      <span id="route-text">➜</span>
      <button class="fab" id="btn-clear-route" style="padding:6px 10px">Effacer</button>
    </div>
  </div>

  <div class="fabs">
    <button class="fab" id="btn-add-center">Ajouter au centre</button>
    <button class="fab" id="btn-me">Moi</button>
    <button class="fab" id="btn-import">⋯</button>
  </div>

  <!-- Drawer -->
  <div class="drawer" id="drawer" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <h3 style="margin:0">Mes lieux</h3>
      <div style="display:flex; gap:8px">
        <button id="btn-export">Exporter</button>
        <button id="btn-close-drawer">Fermer</button>
      </div>
    </div>
    <p id="empty-hint" class="muted" style="display:none">Aucun point pour l’instant.</p>
    <ul id="list" style="list-style:none; padding:0; margin:0; display:grid; gap:8px"></ul>
  </div>

  <!-- Modal Import -->
  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(3px); z-index:7; align-items:flex-end; justify-content:center; padding:16px">
    <div style="background:#111218; border-radius:24px; box-shadow:0 12px 32px rgba(0,0,0,.6); padding:16px; width:100%; max-width:560px; border:1px solid var(--border)">
      <h3 style="margin:0 0 8px 0">Importer JSON / Astuces</h3>
      <p class="muted">Colle une liste de points (même format que l’export), puis clique Importer.</p>
      <textarea id="ta" style="width:100%; height:160px; padding:10px" placeholder='[
  {"id":"p1","title":"Crêperie","lng":-4.49,"lat":48.39,"icon":"🎃","notes":"galettes top"}
]'></textarea>
      <div style="display:flex; justify-content:space-between; margin-top:12px">
        <button class="fab" id="btn-close-modal" style="padding:8px 12px">Fermer</button>
        <div style="display:flex; gap:8px">
          <button class="fab" id="btn-do-import" style="padding:8px 12px">Importer</button>
          <button class="fab" id="btn-load-ex" style="padding:8px 12px">Charger des exemples</button>
        </div>
      </div>
      <hr style="margin:12px 0; border-color:var(--border)" />
      <div class="muted" style="font-size:12px; display:grid; gap:4px">
        <div>• Active « Ajout » puis fais un <b>appui long</b> sur la carte (mobile) ou <b>clic sans bouger</b> (desktop).</div>
        <div>• Marqueurs <b>emoji</b> déplaçables (sauf lieux natifs).</div>
        <div>• Tout est sauvegardé en local (localStorage) — sauf les lieux natifs.</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const STORAGE_KEY = 'brest-guide-points-v1';
  const ROUTE_SRC = 'route-src';
  const ROUTE_LINE = 'route-line';

  // ------- Styles de carte -------
  const STYLE_RASTER_DARK = {
    version: 8,
    sources: {
      'carto-dark': {
        type: 'raster',
        tiles: [
          'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          'https://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        ],
        tileSize: 256,
        attribution: '© OpenStreetMap contributors • © CARTO'
      }
    },
    layers: [{ id: 'base', type: 'raster', source: 'carto-dark', minzoom: 0, maxzoom: 22 }]
  };
  const STYLE_LIBERTY_URL = 'https://tiles.openfreemap.org/styles/liberty';

  let currentStyle = 'dark';        // 'dark' | 'liberty'
  let lastRouteGeoJson = null;      // pour réappliquer la route après switch

  // -------- Lieux natifs (toujours présents) --------
  const ICONS = ['🐈‍⬛','🎃','🧙‍♀️','⚗️'];
  const validIcon = v => ICONS.includes(v) ? v : '🎃';

  const NATIVE_PLACES = [
    { id:'nat-minou',   title:'Phare du Petit Minou',           lng:-4.6189, lat:48.3378, notes:'Spot photo iconique', icon:'🎃',   native:true },
    { id:'nat-marine',  title:'Musée national de la Marine',    lng:-4.4952, lat:48.3834, notes:'Château de Brest',     icon:'🧙‍♀️', native:true },
    { id:'nat-keraliou',title:'Les Viviers de Keraliou',         lng:-4.5305, lat:48.3696, notes:'Fruits de mer',        icon:'🐈‍⬛', native:true }
  ];

  // ------- Map -------
  const map = new maplibregl.Map({
    container: 'map',
    style: STYLE_RASTER_DARK,
    center: [-4.4861, 48.3904],
    zoom: 12,
    attributionControl: true
  });
  map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'bottom-right');

  // Geolocate
  const geo = new maplibregl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true,
    showUserLocation: true,
    showAccuracyCircle: true
  });
  map.addControl(geo, 'bottom-right');

  let currentPos = null;
  geo.on('geolocate', (e) => { currentPos = { lng: e.coords.longitude, lat: e.coords.latitude }; });

  // ---------- Helpers ----------
  function rndId(){ return (crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2)); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---------- State ----------
  let points = loadPoints(); // uniquement les points utilisateur
  let addingMode = false;
  let showLabels = false;
  let markers = {};
  let labelMarkers = {};

  function loadPoints(){
    try {
      const raw = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      return raw.map(p => ({ ...p, icon: validIcon(p.icon || '🎃'), native:false }));
    } catch(e){ return []; }
  }
  function savePoints(){
    const onlyUser = points.filter(p => !p.native);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(onlyUser));
  }

  function clearLabelMarkers(){ Object.values(labelMarkers).forEach(m => m.remove()); labelMarkers = {}; }

  function renderMarkers(){
    Object.values(markers).forEach(m => m.remove());
    markers = {};
    clearLabelMarkers();

    const ALL = [...NATIVE_PLACES, ...points];

    ALL.forEach(p => {
      // emoji marker
      const el = document.createElement('div');
      el.className = 'mk';
      const span = document.createElement('span');
      span.className = 'mk-emoji';
      span.textContent = validIcon(p.icon);
      el.appendChild(span);

      el.addEventListener('mousedown', e => e.stopPropagation());
      el.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
      el.addEventListener('click', e => { e.stopPropagation(); openPopupFor(p); });

      const marker = new maplibregl.Marker({ element: el, draggable: !p.native })
        .setLngLat([p.lng, p.lat]).addTo(map);

      marker.on('dragend', () => {
        if (p.native) return;
        const c = marker.getLngLat();
        updatePoint(p.id, { lng: c.lng, lat: c.lat });
      });

      markers[p.id] = marker;

      if (showLabels) {
        const lbl = document.createElement('div');
        lbl.className = 'lbl';
        lbl.textContent = p.title || 'Point';
        lbl.addEventListener('mousedown', e => e.stopPropagation());
        lbl.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
        lbl.addEventListener('click', e => { e.stopPropagation(); openPopupFor(p); });

        const lblMarker = new maplibregl.Marker({ element: lbl, offset:[0,-28] })
          .setLngLat([p.lng, p.lat]).addTo(map);
        labelMarkers[p.id] = lblMarker;
      }
    });

    updateList();
    document.getElementById('btn-list').innerText = `Lieux (${ALL.length})`;
  }

  // Popup (fond blanc, texte noir) + badge Natif
  function openPopupFor(p){
    const wrap = document.createElement('div');
    wrap.style.minWidth = '240px';
    wrap.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
        <div class="mk" style="border-color:#eee; background:#f4f5f7; width:22px; height:22px">
          <span class="mk-emoji" style="font-size:16px">${escapeHtml(validIcon(p.icon))}</span>
        </div>
        <strong>${escapeHtml(p.title || 'Point')}</strong>
        ${p.native ? '<span style="margin-left:auto;font-size:11px;background:#eee;color:#333;border-radius:8px;padding:2px 6px">Natif</span>' : ''}
      </div>
      <div class="muted" style="font-size:12px; margin-bottom:8px; color:#333">${escapeHtml(p.notes||'')}</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap">
        <button data-act="route">Itinéraire</button>
        ${p.native ? '' : '<button data-act="edit">Modifier</button>'}
        ${p.native ? '' : '<button data-act="delete" style="color:#a60000;background:#ffecec;border-color:#ffc6c6">Supprimer</button>'}
      </div>
    `;

    let popup;
    wrap.querySelector('[data-act="route"]').addEventListener('click', (e)=>{ e.stopPropagation(); routeToPoint(p); });
    const btnE = wrap.querySelector('[data-act="edit"]');
    if (btnE) btnE.addEventListener('click',  (e)=>{ e.stopPropagation(); if(popup) popup.remove(); editPoint(p.id); });
    const btnD = wrap.querySelector('[data-act="delete"]');
    if (btnD) btnD.addEventListener('click',(e)=>{ e.stopPropagation(); if(popup) popup.remove(); removePoint(p.id); });

    popup = new maplibregl.Popup({ closeOnClick: true, maxWidth: '300px' })
      .setLngLat([p.lng, p.lat]).setDOMContent(wrap).addTo(map);
  }

  function addPoint(lng, lat){
    const title = prompt('Titre du lieu ?', 'Nouveau point');
    if (title === null) return;
    const icon = validIcon(prompt('Emoji (🐈‍⬛ / 🎃 / 🧙‍♀️ / ⚗️)', '🎃') || '🎃');
    const p = { id: rndId(), title: title.trim()||'Point', notes:'', lng, lat, icon, native:false };
    points.push(p); savePoints(); renderMarkers(); openPopupFor(p);
  }
  function updatePoint(id, patch){
    if (NATIVE_PLACES.some(n => n.id === id)) return; // natif => ignore
    points = points.map(x => x.id===id?{...x,...patch}:x); savePoints(); renderMarkers();
  }
  function removePoint(id){
    if (NATIVE_PLACES.some(n => n.id === id)) return alert("Ce lieu natif ne peut pas être supprimé.");
    points = points.filter(x=>x.id!==id); savePoints(); renderMarkers(); clearRoute();
  }
  function editPoint(id){
    if (NATIVE_PLACES.some(n => n.id === id)) return alert("Ce lieu natif ne peut pas être modifié.");
    const p = points.find(x=>x.id===id); if(!p) return;
    const t = prompt('Titre', p.title||''); if(t===null)return;
    const n = prompt('Notes', p.notes||''); if(n===null)return;
    const ic = validIcon(prompt('Emoji (🐈‍⬛ / 🎃 / 🧙‍♀️ / ⚗️)', p.icon||'🎃') || p.icon);
    updatePoint(id, { title:t, notes:n, icon:ic });
  }

  // ----------- Liste ----------
  function updateList(){
    const listEl = document.getElementById('list');
    listEl.innerHTML = '';
    const ALL = [...NATIVE_PLACES, ...points];
    document.getElementById('empty-hint').style.display = ALL.length?'none':'block';

    ALL.forEach(p=>{
      const li = document.createElement('li');
      li.className='list-item';
      li.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div class="mk"><span class="mk-emoji">${escapeHtml(validIcon(p.icon))}</span></div>
          <input value="${escapeHtml(p.title)}" ${p.native?'disabled':''} style="font-weight:700;flex:1;border:none;outline:none;background:${p.native?'#15161c':'transparent'};opacity:${p.native?0.8:1}"/>
          ${p.native ? '<span class="muted" style="font-size:12px">Natif</span>' : `
            <select>
              ${ICONS.map(ic => `<option value="${ic}" ${ic===validIcon(p.icon)?'selected':''}>${ic}</option>`).join('')}
            </select>`}
          <button data-act="fly">Voir</button>
          <button data-act="route">Itinéraire</button>
          ${p.native ? '' : '<button data-act="del" style="color:#ff8a8a">Supprimer</button>'}
        </div>
        <textarea placeholder="Notes" ${p.native?'disabled':''} style="min-height:60px;background:${p.native?'#15161c':'#0F1016'};opacity:${p.native?0.8:1}">${escapeHtml(p.notes||'')}</textarea>
      `;
      li.querySelector('[data-act="fly"]').onclick=()=>map.flyTo({center:[p.lng,p.lat],zoom:16});
      li.querySelector('[data-act="route"]').onclick=()=>routeToPoint(p);

      if (!p.native) {
        li.querySelector('[data-act="del"]').onclick=()=>removePoint(p.id);
        li.querySelector('input').oninput=(e)=>updatePoint(p.id,{title:e.target.value});
        li.querySelector('textarea').oninput=(e)=>updatePoint(p.id,{notes:e.target.value});
        li.querySelector('select').onchange=(e)=>updatePoint(p.id,{icon: validIcon(e.target.value)});
      }

      listEl.appendChild(li);
    });
  }

  // ---------- Route (OSRM – walking) ----------
  function clearRoute(){
    if (map.getLayer(ROUTE_LINE)) map.removeLayer(ROUTE_LINE);
    if (map.getSource(ROUTE_SRC)) map.removeSource(ROUTE_SRC);
    lastRouteGeoJson = null;
    document.getElementById('route-badge').style.display = 'none';
  }
  document.getElementById('btn-clear-route').onclick = clearRoute;

  function fitToCoords(coords){
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    coords.forEach(c => { if(c[0]<minX)minX=c[0]; if(c[0]>maxX)maxX=c[0]; if(c[1]<minY)minY=c[1]; if(c[1]>maxY)maxY=c[1]; });
    map.fitBounds([[minX,minY],[maxX,maxY]], { padding: 60, maxZoom: 16, duration: 600 });
  }

  function routeToPoint(p){
    if (currentPos) return fetchRoute([currentPos.lng, currentPos.lat], [p.lng, p.lat]);
    try { geo.trigger(); } catch(e){}
    setTimeout(() => {
      if (currentPos) fetchRoute([currentPos.lng, currentPos.lat], [p.lng, p.lat]);
      else alert('Active la localisation (icône cible à droite) puis réessaie.');
    }, 1200);
  }

  function applyRouteLayer(){
    if (!lastRouteGeoJson) return;
    map.addSource(ROUTE_SRC, { type:'geojson', data:lastRouteGeoJson });
    map.addLayer({ id:ROUTE_LINE, type:'line', source:ROUTE_SRC,
                   paint:{ 'line-color':'#5EA0FF', 'line-width':4, 'line-opacity':0.95 } });
  }

  function fetchRoute(start, end){
    const url = 'https://router.project-osrm.org/route/v1/walking/' + start.join(',') + ';' + end.join(',') + '?overview=full&geometries=geojson&alternatives=false&steps=false';
    fetch(url)
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => {
        if(!data || !data.routes || !data.routes.length) throw new Error('No route');
        const route = data.routes[0];
        const coords = route.geometry.coordinates;

        lastRouteGeoJson = { type:'Feature', geometry:{ type:'LineString', coordinates: coords } };

        if (map.getLayer(ROUTE_LINE)) map.removeLayer(ROUTE_LINE);
        if (map.getSource(ROUTE_SRC)) map.removeSource(ROUTE_SRC);
        applyRouteLayer();

        const distKm = Math.round(route.distance/10)/100; // m->km
        const durMin = Math.round(route.duration/60);      // s->min (walking)
        document.getElementById('route-text').textContent = `➜ ${distKm} km • ~${durMin} min à pied`;
        document.getElementById('route-badge').style.display = 'block';
        fitToCoords(coords);
      })
      .catch(err => { console.warn('OSRM', err); alert("Impossible d'obtenir l’itinéraire (réseau/API)."); });
  }

  // ---------- Click vs Drag pour l'ajout (desktop) ----------
  let isMouseDown = false, startPt = null, moved = false;
  map.on('mousedown', (e) => {
    if (!addingMode) return;
    if (e.originalEvent.button !== 0) return;
    isMouseDown = true; moved = false; startPt = e.point;
  });
  map.on('mousemove', (e) => {
    if (!isMouseDown) return;
    const dx = e.point.x - startPt.x, dy = e.point.y - startPt.y;
    if ((dx*dx + dy*dy) > 25) moved = true; // >5px
  });
  map.on('mouseup', (e) => {
    if (!isMouseDown) return; isMouseDown = false;
    if (!moved && addingMode) addPoint(e.lngLat.lng, e.lngLat.lat);
  });
  map.on('dragstart', () => { moved = true; });

  // Long-press (mobile)
  let pressTimer=null;
  map.on('touchstart', e => { if(!addingMode) return; pressTimer = setTimeout(() => addPoint(e.lngLat.lng, e.lngLat.lat), 450); });
  map.on('touchend', () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });

  // ---------- Buttons ----------
  document.getElementById('btn-me').onclick = () => { try{ geo.trigger(); }catch(e){} };

  const btnAdd = document.getElementById('btn-add');
  btnAdd.onclick = () => {
    addingMode = !addingMode;
    btnAdd.style.background = addingMode ? `linear-gradient(90deg, var(--pink), var(--orange))` : 'var(--bg)';
    btnAdd.style.color = '#fff';
    btnAdd.textContent = addingMode ? 'Ajout ON' : 'Ajout';
  };

  const btnLabels = document.getElementById('btn-labels');
  btnLabels.onclick = () => {
    showLabels = !showLabels;
    btnLabels.style.background = showLabels ? `linear-gradient(90deg, var(--pink), var(--orange))` : 'var(--bg)';
    btnLabels.style.color = '#fff';
    renderMarkers();
  };

  document.getElementById('btn-list').onclick = () => { document.getElementById('drawer').style.display = 'block'; updateList(); };
  document.getElementById('btn-close-drawer').onclick = () => { document.getElementById('drawer').style.display = 'none'; };

  document.getElementById('btn-add-center').onclick = () => { const c = map.getCenter(); addPoint(c.lng, c.lat); };

  document.getElementById('btn-import').onclick = () => { document.getElementById('modal').style.display = 'flex'; };
  document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target === document.getElementById('modal')) document.getElementById('modal').style.display = 'none'; });
  document.getElementById('btn-close-modal').onclick = () => { document.getElementById('modal').style.display = 'none'; };

  document.getElementById('btn-load-ex').onclick = () => {
    const demo = [
      { id:rndId(), title:'Phare du Petit Minou', lng:-4.6189, lat:48.3378, notes:'Spot photo iconique', icon:'🎃',   native:false },
      { id:rndId(), title:'Les Viviers de Keraliou', lng:-4.5305, lat:48.3696, notes:'Fruits de mer',      icon:'🐈‍⬛', native:false },
      { id:rndId(), title:'Musée national de la Marine', lng:-4.4952, lat:48.3834, notes:'Château de Brest', icon:'🧙‍♀️', native:false },
    ];
    points = demo; savePoints(); renderMarkers(); document.getElementById('modal').style.display='none';
  };

  document.getElementById('btn-do-import').onclick = () => {
    try{
      const parsed = JSON.parse(document.getElementById('ta').value);
      if (!Array.isArray(parsed)) throw new Error('Format invalide');
      points = parsed.map(p => ({
        id: p.id || rndId(),
        title: (p.title||'Point'),
        notes: (p.notes||''),
        lng: Number(p.lng),
        lat: Number(p.lat),
        icon: validIcon(p.icon || '🎃'),
        native:false
      })).filter(p => isFinite(p.lng) && isFinite(p.lat));
      savePoints(); renderMarkers(); document.getElementById('modal').style.display='none';
    }catch(e){ alert('JSON invalide'); }
  };

  document.getElementById('btn-export').onclick = () => {
    const blob = new Blob([JSON.stringify(points, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'brest-guide-points.json'; a.click();
    URL.revokeObjectURL(url);
  };

  // --- Toggle de style ---
  document.getElementById('btn-style').onclick = () => {
    if (currentStyle === 'dark') {
      currentStyle = 'liberty';
      map.setStyle(STYLE_LIBERTY_URL);
    } else {
      currentStyle = 'dark';
      map.setStyle(STYLE_RASTER_DARK);
    }
    map.once('styledata', () => { if (lastRouteGeoJson) applyRouteLayer(); });
  };

  // Init
  map.on('load', () => { renderMarkers(); try{ geo.trigger(); }catch(e){} });
})();
</script>
</body>
</html>
