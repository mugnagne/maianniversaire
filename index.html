<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brest Pocket Guide</title>

  <!-- Favicon citrouille (SVG inline) -->
  <link rel="icon" href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect width="64" height="64" rx="12" ry="12" fill="%230B0B0F"/>
      <g transform="translate(0,2)">
        <ellipse cx="32" cy="36" rx="20" ry="18" fill="%23FF7A00"/>
        <ellipse cx="22" cy="36" rx="12" ry="16" fill="%23FF6A00"/>
        <ellipse cx="42" cy="36" rx="12" ry="16" fill="%23FF6A00"/>
        <rect x="30" y="9" width="6" height="10" rx="2" fill="%233A8F2E"/>
        <path d="M29,12 C26,8 22,8 20,10" stroke="%233A8F2E" stroke-width="2" fill="none"/>
        <circle cx="26" cy="32" r="3" fill="%230B0B0F"/>
        <circle cx="38" cy="32" r="3" fill="%230B0B0F"/>
        <path d="M24,40 C28,43 36,43 40,40" stroke="%230B0B0F" stroke-width="3" fill="none" stroke-linecap="round"/>
      </g>
    </svg>' />

  <!-- Google Fonts: Amarante -->
  <link href="https://fonts.googleapis.com/css2?family=Amarante&display=swap" rel="stylesheet">

  <!-- MapLibre GL -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    :root {
      --pink:#FF3366; --orange:#FF5733;
      --bg: rgba(255,255,255,0.06);
      --bg-strong: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.16);
      --shadow: 0 8px 28px rgba(0,0,0,.45);
      --text: #FFFFFF; --muted:#A7A7A7;
      --accent:#7CB8FF;
    }
    *{ box-sizing: border-box }
    html,body{ height:100%; margin:0; background:#0B0B0F; color:var(--text); font-family:"Amarante", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial }
    #map{ position:fixed; inset:0 }

    .topbar{ position:fixed; top:10px; left:12px; right:12px; display:flex; gap:8px; justify-content:space-between; z-index:5 }
    .card{ background:var(--bg); backdrop-filter: blur(8px); padding:8px 12px; border-radius:16px; box-shadow:var(--shadow); border:1px solid var(--border); font-weight:600; color:var(--text) }
    .fabs{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; display:flex; gap:8px; z-index:5; flex-wrap:wrap; justify-content:center }
    .fab{ background:var(--bg); border:1px solid var(--border); padding:10px 14px; border-radius:16px; box-shadow:var(--shadow); font-weight:600; color:var(--text) }

    .drawer{ position:fixed; left:0; right:0; bottom:0; background:#111218; border-radius:24px 24px 0 0; box-shadow:0 -16px 36px rgba(0,0,0,.6); max-height:60vh; overflow:auto; padding:16px; z-index:6; border-top:1px solid var(--border) }
    .list-item{ border:1px solid var(--border); border-radius:16px; padding:12px; display:grid; gap:6px; background:var(--bg-strong) }
    .muted{ color:var(--muted) }

    .mk{ width:22px; height:22px; border-radius:999px; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.45); cursor:pointer }
    .lbl{ white-space:nowrap; font-size:12px; padding:2px 6px; border-radius:10px; background:var(--bg-strong); border:1px solid var(--border); box-shadow:var(--shadow); transform:translateY(-6px); color:var(--text) }

    .route-badge{ position:fixed; left:50%; transform:translateX(-50%); bottom:78px; z-index:5 }
    button{ color:var(--text) }
    input, textarea{ background:#0F1016; color:var(--text); border:1px solid var(--border); border-radius:10px; }
    input[type="color"]{ background:transparent; border:none; }
    a{ color:var(--accent) }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="card">üéÉ Brest Pocket Guide</div>
    <div style="display:flex; gap:8px">
      <button id="btn-list" class="card" aria-label="Ouvrir la liste">Lieux (0)</button>
      <button id="btn-labels" class="card" aria-label="Afficher/masquer les noms">Noms</button>
      <button id="btn-add" class="card" aria-label="Mode ajout">Ajout</button>
    </div>
  </div>

  <div class="route-badge" id="route-badge" style="display:none">
    <div class="card" style="display:flex; gap:8px; align-items:center">
      <span id="route-text">‚ûú</span>
      <button class="fab" id="btn-clear-route" style="padding:6px 10px">Effacer</button>
    </div>
  </div>

  <div class="fabs">
    <button class="fab" id="btn-add-center">Ajouter au centre</button>
    <button class="fab" id="btn-me">Moi</button>
    <button class="fab" id="btn-import">‚ãØ</button>
  </div>

  <!-- Drawer -->
  <div class="drawer" id="drawer" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <h3 style="margin:0">Mes lieux</h3>
      <div style="display:flex; gap:8px">
        <button id="btn-export">Exporter</button>
        <button id="btn-close-drawer">Fermer</button>
      </div>
    </div>
    <p id="empty-hint" class="muted" style="display:none">Aucun point pour l‚Äôinstant. Active ‚ÄúAjout‚Äù ou utilise ‚ÄúAjouter au centre‚Äù.</p>
    <ul id="list" style="list-style:none; padding:0; margin:0; display:grid; gap:8px"></ul>
  </div>

  <!-- Modal Import -->
  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(3px); z-index:7; align-items:flex-end; justify-content:center; padding:16px">
    <div style="background:#111218; border-radius:24px; box-shadow:0 12px 32px rgba(0,0,0,.6); padding:16px; width:100%; max-width:560px; border:1px solid var(--border)">
      <h3 style="margin:0 0 8px 0">Importer JSON / Astuces</h3>
      <p class="muted">Colle une liste de points (m√™me format que l‚Äôexport), puis clique Importer.</p>
      <textarea id="ta" style="width:100%; height:160px; padding:10px" placeholder='[
  {"id":"p1","title":"Cr√™perie","lng":-4.49,"lat":48.39,"notes":"galettes top","color":"#FF3366"}
]'></textarea>
      <div style="display:flex; justify-content:space-between; margin-top:12px">
        <button class="fab" id="btn-close-modal" style="padding:8px 12px">Fermer</button>
        <div style="display:flex; gap:8px">
          <button class="fab" id="btn-do-import" style="padding:8px 12px">Importer</button>
          <button class="fab" id="btn-load-ex" style="padding:8px 12px">Charger des exemples</button>
        </div>
      </div>
      <hr style="margin:12px 0; border-color:var(--border)" />
      <div class="muted" style="font-size:12px; display:grid; gap:4px">
        <div>‚Ä¢ Active ¬´ Ajout ¬ª puis fais un <b>appui long</b> sur la carte pour cr√©er un lieu (mobile) ou <b>clic sans bouger</b> (desktop).</div>
        <div>‚Ä¢ Les marqueurs sont <b>d√©pla√ßables</b>. Tout est sauvegard√© en local (localStorage).</div>
        <div>‚Ä¢ Bouton <b>Moi</b> pour te recentrer. Utilise <b>Itin√©raire</b> dans le popup d‚Äôun lieu.</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const STORAGE_KEY = 'brest-guide-points-v1';
  const ROUTE_SRC = 'route-src';
  const ROUTE_LINE = 'route-line';

  // ------- Style de carte (CARTO Dark Matter, sans cl√©) -------
const STYLE_URL = 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json';

  async function pickStyle(){
    if (!MAPTILER_KEY || MAPTILER_KEY === 'YOUR_MAPTILER_KEY') return FALLBACK_URL;
    try {
      const r = await fetch(DARK_URL, { method:'HEAD' });
      if (r.ok) return DARK_URL;
    } catch(e) {}
    return FALLBACK_URL;
  }
  const STYLE_URL = await pickStyle();

  // ------- Map -------
  const map = new maplibregl.Map({
    container: 'map',
    style: STYLE_URL,
    center: [-4.4861, 48.3904],
    zoom: 12,
    attributionControl: true
  });
  map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'bottom-right');

  // Geolocate
  const geo = new maplibregl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true,
    showUserLocation: true,
    showAccuracyCircle: true
  });
  map.addControl(geo, 'bottom-right');

  let currentPos = null;
  geo.on('geolocate', (e) => { currentPos = { lng: e.coords.longitude, lat: e.coords.latitude }; });

  // ---------- State ----------
  let points = loadPoints();
  let addingMode = false;
  let showLabels = false;
  let markers = {};      // id -> Marker
  let labelMarkers = {}; // id -> Marker (labels)

  function loadPoints(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e){ return []; } }
  function savePoints(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(points)); }

  // ---------- UI refs ----------
  const btnAdd        = document.getElementById('btn-add');
  const btnLabels     = document.getElementById('btn-labels');
  const btnList       = document.getElementById('btn-list');
  const btnAddCenter  = document.getElementById('btn-add-center');
  const btnMeEl       = document.getElementById('btn-me');
  const drawer        = document.getElementById('drawer');
  const listEl        = document.getElementById('list');
  const emptyHint     = document.getElementById('empty-hint');
  const btnExport     = document.getElementById('btn-export');
  const btnCloseDrawer= document.getElementById('btn-close-drawer');
  const modal         = document.getElementById('modal');
  const ta            = document.getElementById('ta');
  const btnImport     = document.getElementById('btn-import');
  const btnCloseModal = document.getElementById('btn-close-modal');
  const btnDoImport   = document.getElementById('btn-do-import');
  const btnLoadEx     = document.getElementById('btn-load-ex');
  const routeBadge    = document.getElementById('route-badge');
  const routeText     = document.getElementById('route-text');
  const btnClearRoute = document.getElementById('btn-clear-route');

  // ---------- Helpers ----------
  function rndId(){ return (crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2)); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function clearLabelMarkers(){ Object.values(labelMarkers).forEach(m => m.remove()); labelMarkers = {}; }

  function renderMarkers(){
    Object.values(markers).forEach(m => m.remove());
    markers = {};
    clearLabelMarkers();

    points.forEach(p => {
      // marker (color)
      const el = document.createElement('div');
      el.className = 'mk';
      el.style.background = p.color || '#FF3366';
      el.addEventListener('mousedown', e => e.stopPropagation());
      el.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
      el.addEventListener('click', e => { e.stopPropagation(); openPopupFor(p); });

      const marker = new maplibregl.Marker({ element: el, draggable: true })
        .setLngLat([p.lng, p.lat]).addTo(map);

      marker.on('dragend', () => {
        const c = marker.getLngLat();
        updatePoint(p.id, { lng: c.lng, lat: c.lat });
      });

      markers[p.id] = marker;

      // label optionnel
      if (showLabels) {
        const lbl = document.createElement('div');
        lbl.className = 'lbl';
        lbl.textContent = p.title || 'Point';
        lbl.addEventListener('mousedown', e => e.stopPropagation());
        lbl.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
        lbl.addEventListener('click', e => { e.stopPropagation(); openPopupFor(p); });

        const lblMarker = new maplibregl.Marker({ element: lbl, draggable:false, offset:[0, -22] })
          .setLngLat([p.lng, p.lat]).addTo(map);
        labelMarkers[p.id] = lblMarker;
      }
    });

    updateList();
    btnList.innerText = `Lieux (${points.length})`;
  }

  // --- popup robuste (handlers avant insertion) ---
  function openPopupFor(p){
    const wrap = document.createElement('div');
    wrap.style.minWidth = '220px';
    wrap.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
        <div style="width:14px; height:14px; border-radius:999px; background:${p.color||'#FF3366'}; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.25)"></div>
        <strong>${escapeHtml(p.title || 'Point')}</strong>
      </div>
      <div style="font-size:12px; color:#DDD; margin-bottom:8px">${escapeHtml(p.notes||'')}</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap">
        <button data-act="route"  class="ml-btn">Itin√©raire</button>
        <button data-act="edit"   class="ml-btn">Modifier</button>
        <button data-act="delete" class="ml-btn" style="color:#ff8a8a">Supprimer</button>
      </div>
    `;
    wrap.addEventListener('mousedown', e => e.stopPropagation());
    wrap.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
    wrap.addEventListener('click', e => e.stopPropagation());

    let popup;
    wrap.querySelector('[data-act="route"]').addEventListener('click', (e)=>{ e.stopPropagation(); routeToPoint(p); });
    wrap.querySelector('[data-act="edit"]').addEventListener('click',  (e)=>{ e.stopPropagation(); popup.remove(); editPoint(p.id); });
    wrap.querySelector('[data-act="delete"]').addEventListener('click',(e)=>{ e.stopPropagation(); popup.remove(); removePoint(p.id); });

    popup = new maplibregl.Popup({ closeOnClick: true, maxWidth: '280px' })
      .setLngLat([p.lng, p.lat]).setDOMContent(wrap).addTo(map);
  }

  function addPoint(lng, lat){
    const title = prompt('Titre du lieu ?', 'Nouveau point');
    if (title === null) return;
    const color = prompt('Couleur hex (ex: #FF3366)', '#FF3366') || '#FF3366';
    const p = { id: rndId(), title: title.trim() || 'Point', notes:'', lng, lat, color };
    points.push(p); savePoints(); renderMarkers(); openPopupFor(p);
  }
  function updatePoint(id, patch){ points = points.map(x => x.id === id ? Object.assign({}, x, patch) : x); savePoints(); renderMarkers(); }
  function removePoint(id){ points = points.filter(x => x.id !== id); savePoints(); renderMarkers(); clearRoute(); }
  function editPoint(id){
    const p = points.find(x => x.id === id); if(!p) return;
    const t = prompt('Titre', p.title || ''); if (t === null) return;
    const n = prompt('Notes', p.notes || ''); if (n === null) return;
    const c = prompt('Couleur hex', p.color || '#FF3366') || p.color;
    updatePoint(id, { title:t, notes:n, color:c });
  }

  function updateList(){
    listEl.innerHTML = '';
    emptyHint.style.display = points.length ? 'none' : 'block';
    points.forEach(p => {
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
          <div class="mk" style="background:${p.color||'#FF3366'}"></div>
          <input value="${escapeHtml(p.title)}" style="font-weight:700; border:none; outline:none; flex:1; min-width:140px" />
          <button data-act="fly">Voir</button>
          <button data-act="route">Itin√©raire</button>
          <button data-act="del" style="color:#ff8a8a">Supprimer</button>
        </div>
        <textarea placeholder="Notes" style="padding:8px; min-height:60px">${escapeHtml(p.notes||'')}</textarea>
        <div class="muted" style="display:flex; align-items:center; gap:8px; font-size:12px">
          <label>Couleur</label>
          <input type="color" value="${p.color||'#FF3366'}" />
          <span>(${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})</span>
        </div>
      `;
      const titleInput = li.querySelector('input');
      const notesTa    = li.querySelector('textarea');
      const colorInput = li.querySelector('input[type="color"]');
      li.querySelector('[data-act="fly"]').onclick   = () => { map.flyTo({ center:[p.lng,p.lat], zoom:16 }); };
      li.querySelector('[data-act="route"]').onclick = () => { routeToPoint(p); };
      li.querySelector('[data-act="del"]').onclick   = () => { removePoint(p.id); };
      titleInput.oninput = (e)=> updatePoint(p.id, { title: e.target.value });
      notesTa.oninput    = (e)=> updatePoint(p.id, { notes: e.target.value });
      colorInput.oninput = (e)=> updatePoint(p.id, { color: e.target.value });
      listEl.appendChild(li);
    });
  }

  // ---------- Route (OSRM ‚Äì walking) ----------
  function clearRoute(){ if (map.getLayer(ROUTE_LINE)) map.removeLayer(ROUTE_LINE); if (map.getSource(ROUTE_SRC)) map.removeSource(ROUTE_SRC); routeBadge.style.display = 'none'; }
  btnClearRoute.onclick = clearRoute;

  function fitToCoords(coords){
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    coords.forEach(c => { if(c[0]<minX)minX=c[0]; if(c[0]>maxX)maxX=c[0]; if(c[1]<minY)minY=c[1]; if(c[1]>maxY)maxY=c[1]; });
    map.fitBounds([[minX,minY],[maxX,maxY]], { padding: 60, maxZoom: 16, duration: 600 });
  }

  function routeToPoint(p){
    if (currentPos) return fetchRoute([currentPos.lng, currentPos.lat], [p.lng, p.lat]);
    try { geo.trigger(); } catch(e){}
    setTimeout(() => { if (currentPos) fetchRoute([currentPos.lng, currentPos.lat], [p.lng, p.lat]); else alert('Active la localisation (ic√¥ne cible √† droite) puis r√©essaie.'); }, 1200);
  }

  function fetchRoute(start, end){
    const url = 'https://router.project-osrm.org/route/v1/walking/' + start.join(',') + ';' + end.join(',') + '?overview=full&geometries=geojson&alternatives=false&steps=false';
    fetch(url)
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => {
        if(!data || !data.routes || !data.routes.length) throw new Error('No route');
        const route = data.routes[0];
        const coords = route.geometry.coordinates;
        clearRoute();
        map.addSource(ROUTE_SRC, { type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates: coords } } });
        map.addLayer({ id:ROUTE_LINE, type:'line', source:ROUTE_SRC, paint:{ 'line-color':'#5EA0FF', 'line-width':4, 'line-opacity':0.95 } });
        const distKm = Math.round(route.distance/10)/100; // m->km
        const durMin = Math.round(route.duration/60);      // s->min (walking)
        routeText.textContent = `‚ûú ${distKm} km ‚Ä¢ ~${durMin} min √† pied`;
        routeBadge.style.display = 'block';
        fitToCoords(coords);
      })
      .catch(err => { console.warn('OSRM', err); alert("Impossible d'obtenir l‚Äôitin√©raire (r√©seau/API)."); });
  }

  // ---------- Click vs Drag pour l'ajout (desktop) ----------
  let isMouseDown = false, startPt = null, moved = false;
  map.on('mousedown', (e) => {
    if (!addingMode) return;
    if (e.originalEvent.button !== 0) return;
    isMouseDown = true; moved = false; startPt = e.point;
  });
  map.on('mousemove', (e) => {
    if (!isMouseDown) return;
    const dx = e.point.x - startPt.x, dy = e.point.y - startPt.y;
    if ((dx*dx + dy*dy) > 25) moved = true; // >5px
  });
  map.on('mouseup', (e) => {
    if (!isMouseDown) return; isMouseDown = false;
    if (!moved && addingMode) addPoint(e.lngLat.lng, e.lngLat.lat);
  });
  map.on('dragstart', () => { moved = true; });

  // Long-press (mobile)
  let pressTimer=null;
  map.on('touchstart', e => { if(!addingMode) return; pressTimer = setTimeout(() => addPoint(e.lngLat.lng, e.lngLat.lat), 450); });
  map.on('touchend', () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });

  // ---------- Buttons ----------
  btnMeEl.onclick = () => { try{ geo.trigger(); }catch(e){} };

  btnAdd.onclick = () => {
    addingMode = !addingMode;
    btnAdd.style.background = addingMode ? `linear-gradient(90deg, var(--pink), var(--orange))` : 'var(--bg)';
    btnAdd.style.color = addingMode ? '#fff' : '#fff';
    btnAdd.textContent = addingMode ? 'Ajout ON' : 'Ajout';
  };

  btnLabels.onclick = () => {
    showLabels = !showLabels;
    btnLabels.style.background = showLabels ? `linear-gradient(90deg, var(--pink), var(--orange))` : 'var(--bg)';
    btnLabels.style.color = '#fff';
    renderMarkers();
  };

  btnList.onclick = () => { drawer.style.display = 'block'; updateList(); };
  btnCloseDrawer.onclick = () => { drawer.style.display = 'none'; };

  btnAddCenter.onclick = () => { const c = map.getCenter(); addPoint(c.lng, c.lat); };

  btnImport.onclick = () => { modal.style.display = 'flex'; };
  modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display = 'none'; });
  btnCloseModal.onclick = () => { modal.style.display = 'none'; };

  btnLoadEx.onclick = () => {
    const demo = [
      { id:rndId(), title:'Phare du Petit Minou', lng:-4.6189, lat:48.3378, notes:'Spot photo iconique', color:'#FF5733' },
      { id:rndId(), title:'Les Viviers de Keraliou', lng:-4.5305, lat:48.3696, notes:'Fruits de mer', color:'#FF3366' },
      { id:rndId(), title:'Mus√©e national de la Marine', lng:-4.4952, lat:48.3834, notes:'Ch√¢teau de Brest', color:'#FF8A00' },
    ];
    points = demo; savePoints(); renderMarkers(); modal.style.display='none';
  };

  btnDoImport.onclick = () => {
    try{
      const parsed = JSON.parse(ta.value);
      if (!Array.isArray(parsed)) throw new Error('Format invalide');
      points = parsed.map(p => ({
        id: p.id || rndId(),
        title: (p.title||'Point'),
        notes: (p.notes||''),
        lng: Number(p.lng),
        lat: Number(p.lat),
        color: p.color || '#FF3366'
      })).filter(p => isFinite(p.lng) && isFinite(p.lat));
      savePoints(); renderMarkers(); modal.style.display='none';
    }catch(e){ alert('JSON invalide'); }
  };

  btnExport.onclick = () => {
    const blob = new Blob([JSON.stringify(points, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'brest-guide-points.json'; a.click();
    URL.revokeObjectURL(url);
  };

  // Init
  map.on('load', () => { renderMarkers(); try{ geo.trigger(); }catch(e){} });
})();
</script>
</body>
</html>
