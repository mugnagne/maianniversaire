<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Brest Pocket Guide</title>

    <!-- MapLibre CSS -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />

    <style>
      html, body, #root { height: 100%; margin: 0; }
      #map { position: absolute; inset: 0; }

      .topbar { position: fixed; left: 12px; right: 12px; top: 10px; display: flex; gap: 8px; justify-content: space-between; z-index: 5; }
      .card { background: #fff9; backdrop-filter: blur(6px); padding: 8px 12px; border-radius: 16px; box-shadow: 0 6px 16px rgba(0,0,0,.12); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
      .fabs { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; display: flex; gap: 8px; z-index: 5; }
      .fab { background: #fff9; border: 1px solid #eee; padding: 10px 14px; border-radius: 16px; box-shadow: 0 6px 16px rgba(0,0,0,.15); font-weight: 600; }

      .drawer { position: fixed; left: 0; right: 0; bottom: 0; background: #fff; border-top-left-radius: 24px; border-top-right-radius: 24px; box-shadow: 0 -8px 24px rgba(0,0,0,.2); max-height: 60vh; overflow: auto; padding: 16px; z-index: 6; }
      .list-item { border: 1px solid #eee; border-radius: 16px; padding: 12px; display: grid; gap: 6px; }
      .muted { color: #666; }

      .mk { width: 22px; height: 22px; border-radius: 999px; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,.25); }

      /* Point bleu user en HTML (au cas o√π le layer n'appara√Æt pas) */
      .me-dot { width: 16px; height: 16px; border-radius: 999px; background: #0a84ff; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React + ReactDOM via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel pour JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- MapLibre via CDN -->
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

    <script type="text/babel" data-presets="react">
      function rndId() {
        if (window.crypto && typeof window.crypto.randomUUID === 'function') {
          return window.crypto.randomUUID();
        }
        return 'id-' + Math.random().toString(36).slice(2);
      }

      // Style MapLibre : tuiles OpenStreetMap raster (routes + noms)
      var OSM_RASTER_STYLE = {
        "version": 8,
        "sources": {
          "osm": {
            "type": "raster",
            "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            "tileSize": 256,
            "attribution": "¬© OpenStreetMap contributors"
          }
        },
        "layers": [
          { "id": "osm-tiles", "type": "raster", "source": "osm" }
        ]
      };

      const STORAGE_KEY = 'brest-guide-points-v1';

      function App(){
        const mapRef = React.useRef(null);
        const containerRef = React.useRef(null);
        const userMarkerRef = React.useRef(null); // fallback HTML marker
        const [points,setPoints] = React.useState(function(){
          try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
          catch(e) { return []; }
        });
        const [adding,setAdding] = React.useState(false);
        const [showList,setShowList] = React.useState(false);
        const [showImport,setShowImport] = React.useState(false);
        const [userPos,setUserPos] = React.useState(null); // {lng,lat,acc}

        React.useEffect(function(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(points)); }, [points]);

        // Init map (style OSM raster)
        React.useEffect(function(){
          if(mapRef.current||!containerRef.current) return;
          var map = new maplibregl.Map({
            container: containerRef.current,
            style: OSM_RASTER_STYLE,
            center: [-4.4861,48.3904], // Brest
            zoom: 12,
            attributionControl: true
          });
          map.addControl(new maplibregl.NavigationControl({showCompass:false}), 'bottom-right');
          mapRef.current = map;

          map.on('load', function(){
            renderMarkers();
            drawUserLayers();
          });

          // Long-press pour ajouter (mobile)
          var t=null;
          map.on('touchstart', function(e){
            if(!adding) return;
            t = setTimeout(function(){ addAt(e.lngLat.lng, e.lngLat.lat); }, 450);
          });
          map.on('touchend', function(){ if(t){ clearTimeout(t); t=null; } });
        }, [adding]);

        // Forcer une demande de permission au d√©marrage (une fois)
        React.useEffect(function(){
          if(!('geolocation' in navigator)) return;
          navigator.geolocation.getCurrentPosition(function(pos){
            var lng = pos.coords.longitude, lat = pos.coords.latitude, acc = pos.coords.accuracy || 30;
            setUserPos({ lng: lng, lat: lat, acc: acc });
            drawUserLayers();
          }, function(){ /* ignore */ }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
        }, []);

        // Watch continu
        React.useEffect(function(){
          if(!('geolocation' in navigator)) return;
          var id = navigator.geolocation.watchPosition(function(pos){
            var lng = pos.coords.longitude, lat = pos.coords.latitude, acc = pos.coords.accuracy || 30;
            setUserPos({ lng: lng, lat: lat, acc: acc });
            drawUserLayers();
          }, function(err){ console.warn('Geolocation error:', err && err.message); }, { enableHighAccuracy:true, maximumAge:5000, timeout:15000 });
          return function(){ if(navigator.geolocation.clearWatch) navigator.geolocation.clearWatch(id); };
        }, []);

        React.useEffect(function(){ renderMarkers(); }, [points]);

        function renderMarkers(){
          var map = mapRef.current;
          if(!map) return;
          document.querySelectorAll('.mk').forEach(function(el){ el.remove(); });
          points.forEach(function(p){
            var el = document.createElement('div');
            el.className = 'mk';
            el.style.background = p.color || '#FF3366';
            var m = new maplibregl.Marker({element: el, draggable: true})
              .setLngLat([p.lng, p.lat])
              .addTo(map);
            m.on('dragend', function(){
              var c = m.getLngLat();
              setPoints(function(prev){
                return prev.map(function(x){
                  return x.id === p.id ? Object.assign({}, x, { lng: c.lng, lat: c.lat }) : x;
                });
              });
            });
          });
        }

        // Calque position utilisateur : cercle + point (et fallback marker HTML)
        function drawUserLayers(){
          var map = mapRef.current;
          if(!map || !userPos) return;

          var center = [userPos.lng, userPos.lat];

          // Fallback marker HTML (toujours visible)
          if(!userMarkerRef.current){
            var el = document.createElement('div');
            el.className = 'me-dot';
            userMarkerRef.current = new maplibregl.Marker({ element: el }).setLngLat(center).addTo(map);
          } else {
            userMarkerRef.current.setLngLat(center);
          }

          // Layers MapLibre (si style pr√™t)
          if (typeof map.isStyleLoaded === 'function' && !map.isStyleLoaded()) return;

          if(!map.getSource('user-point-src')){
            map.addSource('user-point-src', { type:'geojson', data:{ type:'FeatureCollection', features:[{ type:'Feature', geometry:{ type:'Point', coordinates:center } }] } });
            map.addLayer({ id:'user-point', type:'circle', source:'user-point-src', paint:{ 'circle-radius':6, 'circle-color':'#007AFF', 'circle-stroke-width':2, 'circle-stroke-color':'#fff' }});
          } else {
            map.getSource('user-point-src').setData({ type:'FeatureCollection', features:[{ type:'Feature', geometry:{ type:'Point', coordinates:center } }] });
          }

          var meters = Math.max(5, Math.min(userPos.acc, 200));
          var metersToPixelsAtLat = function(m, lat){ return m / (0.075 * Math.cos((lat * Math.PI)/180)); };
          var radiusPx = metersToPixelsAtLat(meters, userPos.lat);

          if(!map.getSource('user-acc-src')){
            map.addSource('user-acc-src', { type:'geojson', data:{ type:'FeatureCollection', features:[{ type:'Feature', geometry:{ type:'Point', coordinates:center } }] } });
            map.addLayer({ id:'user-accuracy', type:'circle', source:'user-acc-src',
              paint:{ 'circle-radius': radiusPx, 'circle-color':'#007AFF22', 'circle-stroke-width':1, 'circle-stroke-color':'#007AFF66' }
            }, 'user-point');
          } else {
            map.getSource('user-acc-src').setData({ type:'FeatureCollection', features:[{ type:'Feature', geometry:{ type:'Point', coordinates:center } }] });
            map.setPaintProperty('user-accuracy', 'circle-radius', radiusPx);
          }
        }

        function addAt(lng,lat){
          var title = prompt('Titre du lieu ?','Nouveau point');
          if(title===null) return;
          var color = prompt('Couleur hex (optionnel)','\\#FF3366') || '#FF3366';
          setPoints(function(prev){
            return prev.concat([{ id:rndId(), title:(title.trim()||'Point'), notes:'', lng: lng, lat: lat, color: color }]);
          });
        }

        function addAtCenter(){
          var c = mapRef.current.getCenter();
          addAt(c.lng, c.lat);
        }

        function centerOnMe(){
          if(userPos) mapRef.current.flyTo({ center:[userPos.lng,userPos.lat], zoom:16, essential:true });
          else alert('Active la localisation pour te centrer üôÇ');
        }

        function exportJSON(){
          var blob = new Blob([JSON.stringify(points, null, 2)], { type:'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url; a.download = 'brest-guide-points.json'; a.click();
          URL.revokeObjectURL(url);
        }

        function importJSON(text){
          try{
            var parsed = JSON.parse(text);
            if(!Array.isArray(parsed)) throw new Error('Format invalide');
            setPoints(parsed.map(function(p){ return Object.assign({}, p, { id: p.id || rndId() }); }));
          } catch(e){ alert('JSON invalide'); }
        }

        return (
          <div style={{height:'100%'}}>
            <div id="map" ref={containerRef}></div>

            {/* Barre haute */}
            <div className="topbar">
              <div className="card"><b>Brest Pocket Guide</b></div>
              <div style={{display:'flex',gap:8}}>
                <button className="card" onClick={function(){ setShowList(function(s){ return !s; }); }} aria-label="Ouvrir la liste">Lieux ({points.length})</button>
                <button className="card" onClick={function(){ setAdding(function(a){ return !a; }); }} aria-pressed={adding} aria-label="Mode ajout"
                        style={{ background: adding ? 'linear-gradient(90deg,#FF3366,#FF5733)' : '#fff9', color: adding ? '#fff' : '#000' }}>
                  {adding ? 'Ajout ON' : 'Ajout'}
                </button>
              </div>
            </div>

            {/* Boutons bas */}
            <div className="fabs">
              <button className="fab" onClick={addAtCenter}>Ajouter au centre</button>
              <button className="fab" onClick={centerOnMe}>Moi</button>
              <button className="fab" onClick={function(){ setShowImport(true); }}>‚ãØ</button>
            </div>

            {/* Tiroir liste */}
            {showList && (
              <div className="drawer" role="dialog" aria-label="Mes lieux">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:8}}>
                  <h3 style={{margin:0}}>Mes lieux</h3>
                  <div style={{display:'flex',gap:8}}>
                    <button onClick={exportJSON}>Exporter</button>
                    <button onClick={function(){ setShowList(false); }}>Fermer</button>
                  </div>
                </div>

                {points.length===0 && <p className="muted">Aucun point pour l'instant. Active ‚ÄúAjout‚Äù ou utilise ‚ÄúAjouter au centre‚Äù.</p>}

                <ul style={{listStyle:'none',padding:0,margin:0,display:'grid',gap:8}}>
                  {points.map(function(p){
                    return (
                      <li key={p.id} className="list-item">
                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                          <div className="mk" style={{background:p.color||'#FF3366'}}></div>
                          <input
                            value={p.title}
                            onChange={function(e){
                              setPoints(function(prev){
                                return prev.map(function(x){
                                  return x.id===p.id ? Object.assign({}, x, { title: e.target.value }) : x;
                                });
                              });
                            }}
                            style={{fontWeight:700,border:'none',outline:'none',flex:1}}
                          />
                          <button onClick={function(){ mapRef.current.flyTo({center:[p.lng,p.lat], zoom:16, essential:true}); }}>Voir</button>
                          <button onClick={function(){
                            setPoints(function(prev){ return prev.filter(function(x){ return x.id!==p.id; }); });
                          }} style={{color:'#d00'}}>Supprimer</button>
                        </div>
                        <textarea
                          placeholder="Notes (horaires, tips, etc.)"
                          value={p.notes||''}
                          onChange={function(e){
                            setPoints(function(prev){
                              return prev.map(function(x){
                                return x.id===p.id ? Object.assign({}, x, { notes: e.target.value }) : x;
                              });
                            });
                          }}
                          style={{border:'1px solid #eee',borderRadius:10,padding:8,minHeight:60}}
                        ></textarea>
                        <div style={{display:'flex',alignItems:'center',gap:8,fontSize:12}} className="muted">
                          <label>Couleur</label>
                          <input type="color" value={p.color||'#FF3366'} onChange={function(e){
                            setPoints(function(prev){
                              return prev.map(function(x){
                                return x.id===p.id ? Object.assign({}, x, { color: e.target.value }) : x;
                              });
                            });
                          }}/>
                          <span>({p.lat.toFixed(5)}, {p.lng.toFixed(5)})</span>
                        </div>
                      </li>
                    );
                  })}
                </ul>
              </div>
            )}

            {/* Modal import / astuces */}
            {showImport && (
              <div onClick={function(){ setShowImport(false); }} style={{position:'fixed',inset:0,background:'rgba(0,0,0,.3)',backdropFilter:'blur(2px)',display:'flex',alignItems:'flex-end',justifyContent:'center',padding:16}}>
                <div onClick={function(e){ e.stopPropagation(); }} style={{background:'#fff',borderRadius:24,boxShadow:'0 12px 32px rgba(0,0,0,.25)',padding:16,width:'100%',maxWidth:560}}>
                  <h3 style={{marginTop:0}}>Importer JSON / Astuces</h3>
                  <p className="muted" style={{marginTop:0}}>Colle une liste de points (m√™me format que l‚Äôexport), puis clique Importer.</p>
                  <textarea id="import-ta" placeholder='[
  {"id":"...","title":"Cr√™perie","lng":-4.49,"lat":48.39,"notes":"galettes top","color":"#FF3366"}
]' style={{width:'100%',height:160,border:'1px solid #eee',borderRadius:12,padding:10}}></textarea>
                  <div style={{display:'flex',justifyContent:'space-between',marginTop:12}}>
                    <button className="fab" style={{padding:'8px 12px'}} onClick={function(){ setShowImport(false); }}>Fermer</button>
                    <div style={{display:'flex',gap:8}}>
                      <button className="fab" style={{padding:'8px 12px'}} onClick={function(){
                        var ta=document.getElementById('import-ta');
                        if(!ta) return;
                        importJSON(ta.value);
                        setShowImport(false);
                      }}>Importer</button>
                      <button className="fab" style={{padding:'8px 12px'}} onClick={function(){
                        var demo = [
                          { id:rndId(), title:'Phare du Petit Minou', lng:-4.6189, lat:48.3378, notes:'Spot photo iconique', color:'#FF5733' },
                          { id:rndId(), title:'Les Viviers de Keraliou', lng:-4.5305, lat:48.3696, notes:'Fruits de mer', color:'#FF3366' },
                          { id:rndId(), title:'Mus√©e national de la Marine', lng:-4.4952, lat:48.3834, notes:'Ch√¢teau de Brest', color:'#FF8A00' },
                        ];
                        setPoints(demo);
                        setShowImport(false);
                      }}>Charger des exemples</button>
                    </div>
                  </div>
                  <hr style={{ margin: "12px 0" }} />
                  <div className="muted" style={{fontSize:12,display:'grid',gap:4}}>
                    <div>‚Ä¢ Active ¬´ Ajout ¬ª puis fais un <b>appui long</b> sur la carte pour cr√©er un lieu.</div>
                    <div>‚Ä¢ Les marqueurs sont <b>d√©pla√ßables</b>. Tout est sauvegard√© en local (localStorage).</div>
                    <div>‚Ä¢ Bouton <b>Moi</b> pour te recentrer.</div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      var root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App/>);
    </script>
  </body>
</html>
