<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guide de Poche</title>

  <link rel="icon" href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
      <rect width="64" height="64" rx="12" ry="12" fill="%230B0B0F"/>
      <g transform="translate(0,2)">
        <ellipse cx="32" cy="36" rx="20" ry="18" fill="%23FF7A00"/>
        <ellipse cx="22" cy="36" rx="12" ry="16" fill="%23FF6A00"/>
        <ellipse cx="42" cy="36" rx="12" ry="16" fill="%23FF6A00"/>
        <rect x="30" y="9" width="6" height="10" rx="2" fill="%233A8F2E"/>
        <path d="M29,12 C26,8 22,8 20,10" stroke="%233A8F2E" stroke-width="2" fill="none"/>
        <circle cx="26" cy="32" r="3" fill="%230B0B0F"/>
        <circle cx="38" cy="32" r="3" fill="%230B0B0F"/>
        <path d="M24,40 C28,43 36,43 40,40" stroke="%230B0B0F" stroke-width="3" fill="none" stroke-linecap="round"/>
      </g>
    </svg>' />

  <link href="https://fonts.googleapis.com/css2?family=Amarante&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    :root{
      --pink:#FF3366; --orange:#FF5733;
      --bg: rgba(255,255,255,0.06);
      --bg-strong: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.16);
      --shadow: 0 8px 28px rgba(0,0,0,.45);
      --text:#fff; --muted:#A7A7A7;
      --accent:#7CB8FF;
      --btn-dark:#2A2B31; --btn-dark-border:#3B3D45; --btn-dark-text:#fff;
      --lantern:#FFD54A; --lantern-border:#C9A73A;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0B0B0F;color:var(--text);font-family:"Amarante",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial}
    #map{position:fixed;inset:0}

    html,body,#map,button,input,select,textarea,
    .card,.fab,.drawer,.list-item,.lbl,
    .maplibregl-ctrl,.maplibregl-ctrl button,.maplibregl-ctrl-group button,
    .maplibregl-popup,.maplibregl-popup-content,.maplibregl-popup *{
      font-family:"Amarante",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial !important;
      font-weight:400;
    }

    .topbar{position:fixed;top:10px;left:12px;right:12px;display:flex;gap:8px;justify-content:space-between;z-index:5}
    .card{background:var(--bg);backdrop-filter:blur(8px);padding:8px 12px;border-radius:16px;box-shadow:var(--shadow);border:1px solid var(--border);font-weight:600;color:var(--text)}
    .fabs{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;display:flex;gap:8px;z-index:5;flex-wrap:wrap;justify-content:center}
    .fab{background:var(--bg);border:1px solid var(--border);padding:10px 14px;border-radius:16px;box-shadow:var(--shadow);font-weight:600;color:var(--text)}

    .drawer{position:fixed;left:0;right:0;bottom:0;background:#111218;border-radius:24px 24px 0 0;box-shadow:0 -16px 36px rgba(0,0,0,.6);max-height:60vh;overflow:auto;padding:16px;z-index:6;border-top:1px solid var(--border)}
    .list-item{border:1px solid var(--border);border-radius:16px;padding:12px;display:grid;gap:6px;background:var(--bg-strong)}
    .muted{color:var(--muted)}

    button{background:var(--btn-dark);color:var(--btn-dark-text);border:1px solid var(--btn-dark-border);border-radius:12px;cursor:pointer}
    .card button,.fab button{background:var(--btn-dark)} /* au cas o√π */

.lantern {}

.lantern.on{
  background: var(--lantern) !important;
  color:#111 !important;
  border:1px solid var(--lantern-border) !important;
  box-shadow:
    0 0 0 2px rgba(0,0,0,.25) inset,
    0 0 18px rgba(255,213,74,.9),
    0 0 36px rgba(255,213,74,.55) !important;
}


    .mk{width:26px;height:26px;border-radius:999px;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;background:#1e1f26}
    .mk-emoji{font-size:18px;line-height:1}

    .lbl{white-space:nowrap;font-size:12px;padding:2px 6px;border-radius:10px;background:var(--bg-strong);border:1px solid var(--border);box-shadow:var(--shadow);transform:translateY(-6px);color:var(--text)}

    .route-badge{position:fixed;left:50%;transform:translateX(-50%);bottom:78px;z-index:5}
    input,textarea,select{background:#0F1016;color:var(--text);border:1px solid var(--border);border-radius:10px}
    input[type="color"]{background:transparent;border:none}
    a{color:var(--accent)}

    .maplibregl-popup-content{background:#fff;color:#111}
    .maplibregl-popup-tip{border-top-color:#fff !important}
    .maplibregl-popup-content button{background:var(--btn-dark);color:var(--btn-dark-text);border:1px solid var(--btn-dark-border)}
    .maplibregl-popup-content strong{color:#111}
    .maplibregl-popup-content .muted{color:#333}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="card">üéÉ Guide de Poche</div>
    <div style="display:flex; gap:8px">
      <button id="btn-list" class="card" aria-label="Ouvrir la liste">Lieux (0)</button>
      <button id="btn-labels" class="card lantern" aria-label="Afficher/masquer les noms">Noms</button>
      <button id="btn-style" class="card" aria-label="Changer de style">Style</button>
      <button id="btn-add" class="card lantern" aria-label="Mode ajout">Ajout</button>
    </div>
  </div>

  <div class="route-badge" id="route-badge" style="display:none">
    <div class="card" style="display:flex; gap:8px; align-items:center">
      <span id="route-text">‚ûú</span>
      <button class="fab" id="btn-clear-route" style="padding:6px 10px">Effacer</button>
    </div>
  </div>

  <div class="fabs">
    <button class="fab" id="btn-add-center">Ajouter au centre</button>
    <button class="fab" id="btn-me">Moi</button>
    <button class="fab" id="btn-import">‚ãØ</button>
  </div>

  <div class="drawer" id="drawer" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <h3 style="margin:0">Mes lieux</h3>
      <div style="display:flex; gap:8px">
        <button id="btn-export">Exporter</button>
        <button id="btn-close-drawer">Fermer</button>
      </div>
    </div>
    <p id="empty-hint" class="muted" style="display:none">Aucun point pour l‚Äôinstant.</p>
    <ul id="list" style="list-style:none; padding:0; margin:0; display:grid; gap:8px"></ul>
  </div>

  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(3px); z-index:7; align-items:flex-end; justify-content:center; padding:16px">
    <div style="background:#111218; border-radius:24px; box-shadow:0 12px 32px rgba(0,0,0,.6); padding:16px; width:100%; max-width:560px; border:1px solid var(--border)">
      <h3 style="margin:0 0 8px 0">Importer JSON / Astuces</h3>
      <p class="muted">Colle une liste de points (m√™me format que l‚Äôexport), puis clique Importer.</p>
      <textarea id="ta" style="width:100%; height:160px; padding:10px" placeholder='[
  {"id":"p1","title":"Cr√™perie","lng":-4.49,"lat":48.39,"icon":"üéÉ","notes":"galettes top"}
]'></textarea>
      <div style="display:flex; justify-content:space-between; margin-top:12px">
        <button class="fab" id="btn-close-modal" style="padding:8px 12px">Fermer</button>
        <div style="display:flex; gap:8px">
          <button class="fab" id="btn-do-import" style="padding:8px 12px">Importer</button>
          <button class="fab" id="btn-load-ex" style="padding:8px 12px">Charger des exemples</button>
        </div>
      </div>
      <hr style="margin:12px 0; border-color:var(--border)" />
      <div class="muted" style="font-size:12px; display:grid; gap:4px">
        <div>‚Ä¢ Active ¬´ Ajout ¬ª puis fais un <b>appui long</b> sur la carte (mobile) ou <b>clic sans bouger</b> (desktop).</div>
        <div>‚Ä¢ Marqueurs <b>emoji</b> d√©pla√ßables (sauf lieux natifs).</div>
        <div>‚Ä¢ Tout est sauvegard√© en local (localStorage) ‚Äî sauf les lieux natifs.</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const STORAGE_KEY = 'brest-guide-points-v1';
  const ROUTE_SRC = 'route-src';
  const ROUTE_LINE = 'route-line';

  const STYLE_RASTER_DARK = {
    version: 8,
    sources: {
      'carto-dark': {
        type: 'raster',
        tiles: [
          'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
          'https://d.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        ],
        tileSize: 256,
        attribution: '¬© La Boucle ‚Ä¢ ¬© Cam'
      }
    },
    layers: [{ id: 'base', type: 'raster', source: 'carto-dark', minzoom: 0, maxzoom: 22 }]
  };
  const STYLE_LIBERTY_URL = 'https://tiles.openfreemap.org/styles/liberty';

  let currentStyle = 'dark';
  let lastRouteGeoJson = null;

  const getFirstGrapheme = (str) => {
    if (!str) return '';
    try {
      if (window.Intl && Intl.Segmenter) {
        const seg = new Intl.Segmenter('fr', { granularity:'grapheme' });
        const it = seg.segment(str)[Symbol.iterator]();
        const first = it.next();
        return first && first.value ? first.value.segment : Array.from(str)[0];
      }
    } catch(e){}
    return Array.from(str)[0]; // fallback
  };
  const validIcon = v => {
    const g = getFirstGrapheme(String(v||'').trim());
    return g || 'üéÉ';
  };

  const NATIVE_PLACES = [
   { id:'nat-minou', title:'Phare du Petit Minou', lng:-4.6189, lat:48.3378, notes:'Spot Photo Iconique', icon:'üì∏', native:true },
{ id:'nat-bargay', title:'Happy Caf√©', lng:-4.5339124, lat:48.3983125, notes:'Bar (pas si) queer', icon:'üè≥Ô∏è‚Äçüåà', native:true },
{ id:'nat-esoboutik', title:'Esoboutik', lng:-4.4938136, lat:48.396122, notes:'Objets et services d\'√©sot√©risme', icon:'üîÆ', native:true },
{ id:'nat-barachouffin', title:'Ludibar', lng:-4.498886602488795, lat:48.38930940632928, notes:'Bar √† jeux de soci√©t√© (zombicide)', icon:'üßü', native:true },
{ id:'nat-barafacho', title:'Cocorico', lng:-4.5339124, lat:48.3908214, notes:'Un bar french-touch de macronofascistes', icon:'üá´üá∑', native:true },
{ id:'nat-lgbtfestival', title:'QueerBrestFest', lng:-4.49975717365375, lat:48.38405327923248, notes:'Festival queer, ouverture en mai dans ce bar', icon:'üè≥Ô∏è‚Äçüåà', native:true },
{ id:'nat-magneto', title:'Magn√©tiseur-R√©flexologue Bertrand', lng:-4.4666244, lat:48.3898283, notes:'escroc notoire', icon:'ü™∞', native:true },
{ id:'nat-restovege', title:'Restaurant V√©g√©tarien', lng:-4.5099941, lat:48.3884699, notes:'Ca a l\'air bon', icon:'ü™¥', native:true },
{ id:'nat-restoinox', title:'Restaurant Tib√©tain', lng:-4.5099941, lat:48.3884699, notes:'Pour d√©couvrir la culture de Kaizen', icon:'üèîÔ∏è', native:true },
{ id:'nat-lieudit', title:'Le Lieu Dit', lng:-4.4698395, lat:48.3964447, notes:'Un Tiers-Lieu associatif :D pleins d\'assos chouettes', icon:'üòé', native:true },
{ id:'nat-tierslieu', title:'La PAM', lng:-4.491765557670681, lat:48.38744594832954, notes:'Un Tiers-Lieu associatif :D pleins d\'√©vents chouettes(drag shows entre autre)', icon:'‚úåÔ∏è', native:true },
{ id:'nat-detraqueer', title:'Detraqueer', lng:-4.5083712, lat:48.3942593, notes:'Association LGBQIA+ (peut-√™tre dissoute, √† voir)', icon:'üè≥Ô∏è‚Äçüåà', native:true },
{ id:'nat-facholand', title:'Les Grandes Manoeuvres', lng:-4.4820174, lat:48.4039802, notes:'Un magasin de surplus militaire', icon:'ü™ñ', native:true },
{ id:'nat-goat', title:'Kergoat', lng:-4.5485743, lat:48.4005729, notes:'Quartier des goats', icon:'üêê', native:true },
{ id:'nat-exposympas', title:'Maison de la fontaine', lng:-4.4995203730154, lat:48.382189527354335, notes:'Mus√©e sympa avec des expos cool souvent', icon:'üé®', native:true },
{ id:'nat-bm1', title:'B&M', lng:-4.5463728, lat:48.3868684, notes:'L\'√©quivalent de Noz mais en moins bien', icon:'üí∞', native:true },
{ id:'nat-Action', title:'Action', lng:-4.4900781, lat:48.4086814, notes:'L\'√©quivalent de Noz mais en moins bien', icon:'üí∏', native:true },
{ id:'nat-tribunal', title:'Tribunal', lng:-4.480661817, lat:48.3848405, notes:'tribunal si tu commets des m√©faits', icon:'üïç', native:true },
{ id:'nat-stade', title:'Stade Francis le Bl√©', lng:-4.4893917, lat:48.4030208, notes:'Le Stade Brestois 29, domicile des "Les Ty\' Zefs"', icon:'üèüÔ∏è', native:true },
{ id:'nat-barirish', title:'The Dubliners', lng:-4.4876203, lat:48.3992119, notes:'Bar chouette avec une d√©co marrante', icon:'üçª', native:true },
{ id:'nat-streetart', title:'Rond point de Palaren', lng:-4.4377984, lat:48.3970707, notes:'Lieu de street-art !', icon:'‚úèÔ∏è', native:true },
{ id:'nat-baralt', title:'Le Mouton √Ä Cinq Pattes', lng:-4.4811406, lat:48.3968457, notes:'bar associatif et inclusif, ambiance safe', icon:'üçπ', native:true },
{ id:'nat-cafe', title:'Caf√© de la Plage', lng:-4.5109502, lat:48.3971903, notes:'bar mythique et artsy de brest', icon:'üêâ', native:true },
{ id:'nat-concert', title:'La Car√®ne', lng:-4.4848791, lat:48.3845707, notes:'salle de concert chouette', icon:'üë©‚Äçüé§', native:true },
{ id:'nat-boite', title:'La Suite', lng:-4.4869176, lat:48.3851707, notes:'boite de nuit pas trop cringe', icon:'ü™©', native:true },
{ id:'nat-theatre', title:'La Maison du Th√©√¢tre', lng:-4.5044215, lat:48.4098352, notes:'Th√©√¢tre sympa en fonction de la progra', icon:'üé≠', native:true },
{ id:'nat-tierslieuencore', title:'Les Ateliers des Capucins', lng:-4.5008444, lat:48.3890457, notes:'Tiers lieu avec une super bonne ambiance (skate chill)', icon:'üõπ', native:true },
{ id:'nat-plage', title:'Plage du Moulin Blanc', lng:-4.4387813, lat:48.3586212, notes:'Plage chouette √† la tomb√©e de la nuit !', icon:'üèñÔ∏è', native:true },
{ id:'nat-passerelle', title:'Passerelle Centre d\'art Contemporain', lng:-4.4828383, lat:48.3976316, notes:'Lieu d\'exposition assez cool', icon:'üñºÔ∏è', native:true },
{ id:'nat-salle', title:'MacOrlan', lng:-4.5059022, lat:48.3845092, notes:'Salle de concert pas trop mal mais bon c\'est brest hyn', icon:'üßë‚Äçüé§', native:true },
{ id:'nat-barprolo', title:'Moal Gaelle', lng:-4.4562796, lat:48.4154704, notes:'bar tr√®s flippant (je conseille les photos sur google maps)', icon:'‚ò†Ô∏è', native:true },
{ id:'nat-maremaheu', title:'Mare Maheu', lng:-1.6674217, lat:48.2107519, notes:'endroit flippant (attention au fant√¥me)', icon:'üëª', native:true },

  ];

  const map = new maplibregl.Map({
    container: 'map',
    style: STYLE_RASTER_DARK,
    center: [-4.4861, 48.3904],
    zoom: 12,
    attributionControl: true
  });
  map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'bottom-right');

  const geo = new maplibregl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true,
    showUserLocation: true,
    showAccuracyCircle: true
  });
  map.addControl(geo, 'bottom-right');

  let currentPos = null;
  geo.on('geolocate', (e) => { currentPos = { lng: e.coords.longitude, lat: e.coords.latitude }; });

  let points = loadPoints();
  let addingMode = false;
  let showLabels = false;
  let markers = {};
  let labelMarkers = {};

  function loadPoints(){
    try {
      const raw = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      return raw.map(p => ({ ...p, icon: validIcon(p.icon), native:false }));
    } catch(e){ return []; }
  }
  function savePoints(){
    const onlyUser = points.filter(p => !p.native);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(onlyUser));
  }

  function clearLabelMarkers(){ Object.values(labelMarkers).forEach(m => m.remove()); labelMarkers = {}; }

  function renderMarkers(){
    Object.values(markers).forEach(m => m.remove());
    markers = {};
    clearLabelMarkers();

    const ALL = [...NATIVE_PLACES, ...points];

    ALL.forEach(p => {
      const el = document.createElement('div');
      el.className = 'mk';
      const span = document.createElement('span');
      span.className = 'mk-emoji';
      span.textContent = validIcon(p.icon);
      el.appendChild(span);

      el.addEventListener('mousedown', e => e.stopPropagation());
      el.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
      el.addEventListener('click', e => { e.stopPropagation(); openPopupFor(p); });

      const marker = new maplibregl.Marker({ element: el, draggable: !p.native })
        .setLngLat([p.lng, p.lat]).addTo(map);

      marker.on('dragend', () => {
        if (p.native) return;
        const c = marker.getLngLat();
        updatePoint(p.id, { lng: c.lng, lat: c.lat });
      });

      markers[p.id] = marker;

      if (showLabels) {
        const lbl = document.createElement('div');
        lbl.className = 'lbl';
        lbl.textContent = p.title || 'Point';
        lbl.addEventListener('mousedown', e => e.stopPropagation());
        lbl.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
        lbl.addEventListener('click', e => { e.stopPropagation(); openPopupFor(p); });

        const lblMarker = new maplibregl.Marker({ element: lbl, offset:[0,-28] })
          .setLngLat([p.lng, p.lat]).addTo(map);
        labelMarkers[p.id] = lblMarker;
      }
    });

    updateList();
    document.getElementById('btn-list').innerText = `Lieux (${ALL.length})`;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function rndId(){ return (crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2)); }

  function openPopupFor(p){
    const wrap = document.createElement('div');
    wrap.style.minWidth = '240px';
    wrap.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
        <div class="mk" style="border-color:#eee; background:#f4f5f7; width:22px; height:22px">
          <span class="mk-emoji" style="font-size:16px">${escapeHtml(validIcon(p.icon))}</span>
        </div>
        <strong>${escapeHtml(p.title || 'Point')}</strong>
        ${p.native ? '<span style="margin-left:auto;font-size:11px;background:#eee;color:#333;border-radius:8px;padding:2px 6px">Natif</span>' : ''}
      </div>
      <div class="muted" style="font-size:12px; margin-bottom:8px; color:#333">${escapeHtml(p.notes||'')}</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap">
        <button data-act="route">Itin√©raire</button>
        ${p.native ? '' : '<button data-act="edit">Modifier</button>'}
        ${p.native ? '' : '<button data-act="delete" style="border-color:#6b1b1b;background:#3a1414">Supprimer</button>'}
      </div>
    `;

    let popup;
    wrap.querySelector('[data-act="route"]').addEventListener('click', (e)=>{ e.stopPropagation(); routeToPoint(p); });
    const btnE = wrap.querySelector('[data-act="edit"]');
    if (btnE) btnE.addEventListener('click',  (e)=>{ e.stopPropagation(); if(popup) popup.remove(); editPoint(p.id); });
    const btnD = wrap.querySelector('[data-act="delete"]');
    if (btnD) btnD.addEventListener('click',(e)=>{ e.stopPropagation(); if(popup) popup.remove(); removePoint(p.id); });

    popup = new maplibregl.Popup({ closeOnClick: true, maxWidth: '300px' })
      .setLngLat([p.lng, p.lat]).setDOMContent(wrap).addTo(map);
  }

  function addPoint(lng, lat){
    const title = prompt('Titre du lieu ?', 'Nouveau point');
    if (title === null) return;
    const iconInput = prompt('Emoji (n‚Äôimporte lequel)', 'üéÉ') || 'üéÉ';
    const icon = validIcon(iconInput);
    const p = { id: rndId(), title: title.trim()||'Point', notes:'', lng, lat, icon, native:false };
    points.push(p); savePoints(); renderMarkers(); openPopupFor(p);
  }
  function updatePoint(id, patch){
    if (NATIVE_PLACES.some(n => n.id === id)) return;
    points = points.map(x => x.id===id?{...x,...patch}:x); savePoints(); renderMarkers();
  }
  function removePoint(id){
    if (NATIVE_PLACES.some(n => n.id === id)) return alert("Ce lieu natif ne peut pas √™tre supprim√©.");
    points = points.filter(x=>x.id!==id); savePoints(); renderMarkers(); clearRoute();
  }
  function editPoint(id){
    if (NATIVE_PLACES.some(n => n.id === id)) return alert("Ce lieu natif ne peut pas √™tre modifi√©.");
    const p = points.find(x=>x.id===id); if(!p) return;
    const t = prompt('Titre', p.title||''); if(t===null)return;
    const n = prompt('Notes', p.notes||''); if(n===null)return;
    const ic = validIcon(prompt('Emoji (n‚Äôimporte lequel)', p.icon||'üéÉ') || p.icon);
    updatePoint(id, { title:t, notes:n, icon:ic });
  }

  function updateList(){
    const listEl = document.getElementById('list');
    listEl.innerHTML = '';
    const ALL = [...NATIVE_PLACES, ...points];
    document.getElementById('empty-hint').style.display = ALL.length?'none':'block';

    ALL.forEach(p=>{
      const li = document.createElement('li');
      li.className='list-item';
      li.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div class="mk"><span class="mk-emoji">${escapeHtml(validIcon(p.icon))}</span></div>
          <input value="${escapeHtml(p.title)}" ${p.native?'disabled':''} style="font-weight:700;flex:1;border:none;outline:none;background:${p.native?'#15161c':'transparent'};opacity:${p.native?0.8:1}"/>
          ${p.native ? '<span class="muted" style="font-size:12px">Natif</span>' : `
            <input class="emoji-input" value="${escapeHtml(validIcon(p.icon))}" style="width:54px;text-align:center" maxlength="8" />
          `}
          <button data-act="fly">Voir</button>
          <button data-act="route">Itin√©raire</button>
          ${p.native ? '' : '<button data-act="del" style="border-color:#6b1b1b;background:#3a1414">Supprimer</button>'}
        </div>
        <textarea placeholder="Notes" ${p.native?'disabled':''} style="min-height:60px;background:${p.native?'#15161c':'#0F1016'};opacity:${p.native?0.8:1}">${escapeHtml(p.notes||'')}</textarea>
      `;
      li.querySelector('[data-act="fly"]').onclick=()=>map.flyTo({center:[p.lng,p.lat],zoom:16});
      li.querySelector('[data-act="route"]').onclick=()=>routeToPoint(p);

      if (!p.native) {
        li.querySelector('[data-act="del"]').onclick=()=>removePoint(p.id);
        li.querySelector('input').oninput=(e)=>updatePoint(p.id,{title:e.target.value});
        li.querySelector('textarea').oninput=(e)=>updatePoint(p.id,{notes:e.target.value});
        const emojiInput = li.querySelector('.emoji-input');
        emojiInput.oninput = (e)=>{
          const first = validIcon(e.target.value);
          e.target.value = first;
          updatePoint(p.id, { icon:first });
        };
      }

      listEl.appendChild(li);
    });
  }

  function clearRoute(){
    if (map.getLayer(ROUTE_LINE)) map.removeLayer(ROUTE_LINE);
    if (map.getSource(ROUTE_SRC)) map.removeSource(ROUTE_SRC);
    lastRouteGeoJson = null;
    document.getElementById('route-badge').style.display = 'none';
  }
  document.getElementById('btn-clear-route').onclick = clearRoute;

  function fitToCoords(coords){
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    coords.forEach(c => { if(c[0]<minX)minX=c[0]; if(c[0]>maxX)maxX=c[0]; if(c[1]<minY)minY=c[1]; if(c[1]>maxY)maxY=c[1]; });
    map.fitBounds([[minX,minY],[maxX,maxY]], { padding:60, maxZoom:16, duration:600 });
  }

  function routeToPoint(p){
    if (currentPos) return fetchRoute([currentPos.lng, currentPos.lat], [p.lng, p.lat]);
    try { geo.trigger(); } catch(e){}
    setTimeout(() => {
      if (currentPos) fetchRoute([currentPos.lng, currentPos.lat], [p.lng, p.lat]);
      else alert('Active la localisation (ic√¥ne cible √† droite) puis r√©essaie.');
    }, 1200);
  }

  function applyRouteLayer(){
    if (!lastRouteGeoJson) return;
    map.addSource(ROUTE_SRC, { type:'geojson', data:lastRouteGeoJson });
    map.addLayer({ id:ROUTE_LINE, type:'line', source:ROUTE_SRC,
                   paint:{ 'line-color':'#5EA0FF', 'line-width':4, 'line-opacity':0.95 } });
  }

  function fetchRoute(start, end){
    const url = 'https://router.project-osrm.org/route/v1/walking/' + start.join(',') + ';' + end.join(',') + '?overview=full&geometries=geojson&alternatives=false&steps=false';
    fetch(url)
      .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(data => {
        if(!data || !data.routes || !data.routes.length) throw new Error('No route');
        const route = data.routes[0];
        const coords = route.geometry.coordinates;

        lastRouteGeoJson = { type:'Feature', geometry:{ type:'LineString', coordinates: coords } };

        if (map.getLayer(ROUTE_LINE)) map.removeLayer(ROUTE_LINE);
        if (map.getSource(ROUTE_SRC)) map.removeSource(ROUTE_SRC);
        applyRouteLayer();

        const distKm = Math.round(route.distance/10)/100;
        const durMin = Math.round(route.duration/60);
        document.getElementById('route-text').textContent = `‚ûú ${distKm} km ‚Ä¢ ~${durMin} min √† pied`;
        document.getElementById('route-badge').style.display = 'block';
        fitToCoords(coords);
      })
      .catch(err => { console.warn('OSRM', err); alert("Impossible d'obtenir l‚Äôitin√©raire (r√©seau/API)."); });
  }

  let isMouseDown=false, startPt=null, moved=false;
  map.on('mousedown', (e) => {
    if (!addingMode) return;
    if (e.originalEvent.button !== 0) return;
    isMouseDown = true; moved = false; startPt = e.point;
  });
  map.on('mousemove', (e) => {
    if (!isMouseDown) return;
    const dx = e.point.x - startPt.x, dy = e.point.y - startPt.y;
    if ((dx*dx + dy*dy) > 25) moved = true;
  });
  map.on('mouseup', (e) => {
    if (!isMouseDown) return; isMouseDown = false;
    if (!moved && addingMode) addPoint(e.lngLat.lng, e.lngLat.lat);
  });
  map.on('dragstart', () => { moved = true; });

  let pressTimer=null;
  map.on('touchstart', e => { if(!addingMode) return; pressTimer=setTimeout(()=>addPoint(e.lngLat.lng,e.lngLat.lat),450); });
  map.on('touchend', () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });

  document.getElementById('btn-me').onclick = () => { try{ geo.trigger(); }catch(e){} };

  const btnAdd = document.getElementById('btn-add');
  btnAdd.onclick = () => {
    addingMode = !addingMode;
    btnAdd.classList.toggle('on', addingMode);
  };
  const btnLabels = document.getElementById('btn-labels');
  btnLabels.onclick = () => {
    showLabels = !showLabels;
    btnLabels.classList.toggle('on', showLabels);
    renderMarkers();
  };

  document.getElementById('btn-list').onclick = () => { document.getElementById('drawer').style.display = 'block'; updateList(); };
  document.getElementById('btn-close-drawer').onclick = () => { document.getElementById('drawer').style.display = 'none'; };
  document.getElementById('btn-add-center').onclick = () => { const c = map.getCenter(); addPoint(c.lng, c.lat); };
  document.getElementById('btn-import').onclick = () => { document.getElementById('modal').style.display = 'flex'; };
  document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target === document.getElementById('modal')) document.getElementById('modal').style.display = 'none'; });
  document.getElementById('btn-close-modal').onclick = () => { document.getElementById('modal').style.display = 'none'; };

  document.getElementById('btn-load-ex').onclick = () => {
    const demo = [
      { id:'nat-minou', title:'Phare du Petit Minou', lng:-4.6189, lat:48.3378, notes:'Spot Photo Iconique', icon:'üì∏', native:true },
{ id:'nat-bargay', title:'Happy Caf√©', lng:-4.5339124, lat:48.3983125, notes:'Bar (pas si) queer', icon:'üè≥Ô∏è‚Äçüåà', native:true },
{ id:'nat-esoboutik', title:'Esoboutik', lng:-4.4938136, lat:48.396122, notes:'Objets et services d\'√©sot√©risme', icon:'üîÆ', native:true },
{ id:'nat-barachouffin', title:'Ludibar', lng:-4.498886602488795, lat:48.38930940632928, notes:'Bar √† jeux de soci√©t√© (zombicide)', icon:'üßü', native:true },
{ id:'nat-barafacho', title:'Cocorico', lng:-4.5339124, lat:48.3908214, notes:'Un bar french-touch de macronofascistes', icon:'üá´üá∑', native:true },
{ id:'nat-lgbtfestival', title:'QueerBrestFest', lng:-4.49975717365375, lat:48.38405327923248, notes:'Festival queer, ouverture en mai dans ce bar', icon:'üè≥Ô∏è‚Äçüåà', native:true },
{ id:'nat-magneto', title:'Magn√©tiseur-R√©flexologue Bertrand', lng:-4.4666244, lat:48.3898283, notes:'escroc notoire', icon:'ü™∞', native:true },
{ id:'nat-restovege', title:'Restaurant V√©g√©tarien', lng:-4.5099941, lat:48.3884699, notes:'Ca a l\'air bon', icon:'ü™¥', native:true },
{ id:'nat-restoinox', title:'Restaurant Tib√©tain', lng:-4.5099941, lat:48.3884699, notes:'Pour d√©couvrir la culture de Kaizen', icon:'üèîÔ∏è', native:true },
{ id:'nat-lieudit', title:'Le Lieu Dit', lng:-4.4698395, lat:48.3964447, notes:'Un Tiers-Lieu associatif :D pleins d\'assos chouettes', icon:'üòé', native:true },
{ id:'nat-tierslieu', title:'La PAM', lng:-4.491765557670681, lat:48.38744594832954, notes:'Un Tiers-Lieu associatif :D pleins d\'√©vents chouettes(drag shows entre autre)', icon:'‚úåÔ∏è', native:true },
{ id:'nat-detraqueer', title:'Detraqueer', lng:-4.5083712, lat:48.3942593, notes:'Association LGBQIA+ (peut-√™tre dissoute, √† voir)', icon:'üè≥Ô∏è‚Äçüåà', native:true },
{ id:'nat-facholand', title:'Les Grandes Manoeuvres', lng:-4.6289855, lat:48.4039786, notes:'Un magasin de surplus militaire', icon:'ü™ñ', native:true },
{ id:'nat-goat', title:'Kergoat', lng:-4.5485743, lat:48.4005729, notes:'Quartier des goats', icon:'üêê', native:true },
{ id:'nat-exposympas', title:'Maison de la fontaine', lng:-4.4995203730154, lat:48.382189527354335, notes:'Mus√©e sympa avec des expos cool souvent', icon:'üé®', native:true },
{ id:'nat-bm1', title:'B&M', lng:-4.5463728, lat:48.3868684, notes:'L\'√©quivalent de Noz mais en moins bien', icon:'üí∞', native:true },
{ id:'nat-Action', title:'Action', lng:-4.4900781, lat:48.4086814, notes:'L\'√©quivalent de Noz mais en moins bien', icon:'üí∏', native:true },
{ id:'nat-tribunal', title:'Tribunal', lng:-4.480661817, lat:48.3848405, notes:'tribunal si tu commets des m√©faits', icon:'üïç', native:true },
{ id:'nat-stade', title:'Stade Francis le Bl√©', lng:-4.4893917, lat:48.4030208, notes:'Le Stade Brestois 29, domicile des "Les Ty\' Zefs"', icon:'üèüÔ∏è', native:true },
{ id:'nat-barirish', title:'The Dubliners', lng:-4.4876203, lat:48.3992119, notes:'Bar chouette avec une d√©co marrante', icon:'üçª', native:true },
{ id:'nat-streetart', title:'Rond point de Palaren', lng:-4.4377984, lat:48.3970707, notes:'Lieu de street-art !', icon:'‚úèÔ∏è', native:true },
{ id:'nat-baralt', title:'Le Mouton √Ä Cinq Pattes', lng:-4.4811406, lat:48.3968457, notes:'bar associatif et inclusif, ambiance safe', icon:'üçπ', native:true },
{ id:'nat-cafe', title:'Caf√© de la Plage', lng:-4.5109502, lat:48.3971903, notes:'bar mythique et artsy de brest', icon:'üêâ', native:true },
{ id:'nat-concert', title:'La Car√®ne', lng:-4.4848791, lat:48.3845707, notes:'salle de concert chouette', icon:'üë©‚Äçüé§', native:true },
{ id:'nat-boite', title:'La Suite', lng:-4.4869176, lat:48.3851707, notes:'boite de nuit pas trop cringe', icon:'ü™©', native:true },
{ id:'nat-theatre', title:'La Maison du Th√©√¢tre', lng:-4.5044215, lat:48.4098352, notes:'Th√©√¢tre sympa en fonction de la progra', icon:'üé≠', native:true },
{ id:'nat-tierslieuencore', title:'Les Ateliers des Capucins', lng:-4.5008444, lat:48.3890457, notes:'Tiers lieu avec une super bonne ambiance (skate chill)', icon:'üõπ', native:true },
{ id:'nat-plage', title:'Plage du Moulin Blanc', lng:-4.4387813, lat:48.3586212, notes:'Plage chouette √† la tomb√©e de la nuit !', icon:'üèñÔ∏è', native:true },
{ id:'nat-passerelle', title:'Passerelle Centre d\'art Contemporain', lng:-4.4828383, lat:48.3976316, notes:'Lieu d\'exposition assez cool', icon:'üñºÔ∏è', native:true },
{ id:'nat-salle', title:'MacOrlan', lng:-4.5059022, lat:48.3845092, notes:'Salle de concert pas trop mal mais bon c\'est brest hyn', icon:'üßë‚Äçüé§', native:true },
{ id:'nat-barprolo', title:'Moal Gaelle', lng:-4.4562796, lat:48.4154704, notes:'bar tr√®s flippant (je conseille les photos sur google maps)', icon:'‚ò†Ô∏è', native:true },
    ];
    points = demo; savePoints(); renderMarkers(); document.getElementById('modal').style.display='none';
  };

  document.getElementById('btn-do-import').onclick = () => {
    try{
      const parsed = JSON.parse(document.getElementById('ta').value);
      if (!Array.isArray(parsed)) throw new Error('Format invalide');
      points = parsed.map(p => ({
        id: p.id || rndId(),
        title: (p.title||'Point'),
        notes: (p.notes||''),
        lng: Number(p.lng),
        lat: Number(p.lat),
        icon: validIcon(p.icon),
        native:false
      })).filter(p => isFinite(p.lng) && isFinite(p.lat));
      savePoints(); renderMarkers(); document.getElementById('modal').style.display='none';
    }catch(e){ alert('JSON invalide'); }
  };

  document.getElementById('btn-export').onclick = () => {
    const blob = new Blob([JSON.stringify(points, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'brest-guide-points.json'; a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById('btn-style').onclick = () => {
    if (currentStyle === 'dark') {
      currentStyle = 'liberty';
      map.setStyle(STYLE_LIBERTY_URL);
    } else {
      currentStyle = 'dark';
      map.setStyle(STYLE_RASTER_DARK);
    }
    map.once('styledata', () => { if (lastRouteGeoJson) applyRouteLayer(); renderMarkers(); });
  };

  map.on('load', () => { renderMarkers(); try{ geo.trigger(); }catch(e){} });
})();
</script>
</body>
</html>
